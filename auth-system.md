# Система аутентификации и авторизации

## Общие принципы

Система аутентификации и авторизации построена на JWT токенах с использованием RS256 алгоритма подписи. Реализована ролевая система доступа (RBAC) с четким разделением прав доступа. Все действия пользователей логируются в аудит систему.

## Аутентификация

### JWT токены
- Access токены: 15 минут жизни
- Refresh токены: 7 дней жизни
- Используется RS256 алгоритм подписи
- Токены содержат минимальный набор данных (ID пользователя, роли)

### Процесс аутентификации
1. Пользователь отправляет учетные данные на `/api/v1/auth/login`
2. Сервер проверяет учетные данные
3. Генерируются JWT токены (access и refresh)
4. Refresh токен сохраняется в HTTP-only cookie
5. Access токен возвращается в теле ответа

### Обновление токенов
1. При истечении access токена клиент отправляет refresh токен
2. Сервер проверяет refresh токен
3. Генерируются новые токены
4. Старый refresh токен аннулируется

### Выход из системы
1. Клиент отправляет запрос на `/api/v1/auth/logout`
2. Refresh токен аннулируется в базе данных
3. HTTP-only cookie удаляется

## Авторизация (RBAC)

### Роли пользователей
1. **admin** - Полный доступ ко всем функциям системы
2. **portfolio_manager** - Управление портфелем проектов, просмотр всех проектов
3. **project_manager** - Управление своими проектами, просмотр своих проектов
4. **viewer** - Только просмотр данных, без возможности изменения

### Права доступа по ролям

#### admin
- Полный доступ ко всем проектам
- Управление пользователями и ролями
- Доступ к аудит логам
- Управление системными настройками

#### portfolio_manager
- Создание и редактирование всех проектов
- Назначение менеджеров проектов
- Просмотр отчетов по всему портфелю
- Управление технологическим стеком

#### project_manager
- Создание и редактирование своих проектов
- Управление задачами своих проектов
- Регистрация рисков своих проектов
- Просмотр KPI своих проектов

#### viewer
- Просмотр проектов, к которым предоставлен доступ
- Просмотр отчетов по разрешенным проектам
- Просмотр KPI и рисков по разрешенным проектам

### Контроль доступа к проектам
- Доступ к проектам ограничен по принадлежности к команде
- Владелец проекта имеет полный доступ
- Члены команды имеют доступ к данным проекта
- Portfolio manager имеет доступ ко всем проектам

## Аудит и логирование

### Аудит лог
Все действия пользователей записываются в аудит лог:
- Кто выполнил действие (ID пользователя)
- Какое действие было выполнено
- Над какой сущностью (тип и ID)
- Время выполнения действия
- Детали действия (JSON)

### Логирование безопасности
- Все попытки входа (успешные и неуспешные)
- Попытки несанкционированного доступа
- Изменения ролей пользователей
- Аннулирование токенов

## Защита и безопасность

### Защита токенов
- Access токены передаются в заголовке Authorization
- Refresh токены хранятся в HTTP-only cookie
- Используются secure и same-site флаги для cookie
- Токены не передаются в URL параметрах

### Rate limiting
- Ограничение на количество попыток входа (5 попыток в час)
- Ограничение на обновление токенов (10 раз в час)
- Общее ограничение на API запросы (1000 в час)

### Защита от CSRF
- Использование HTTP-only cookie для refresh токенов
- Проверка Origin и Referer заголовков
- Custom headers для AJAX запросов

### Шифрование данных
- Пароли хранятся в виде хешей (bcrypt)
- Чувствительные данные шифруются при хранении
- Используется TLS для всех соединений

## Интеграция с внешними системами

### SSO (опционально)
- Поддержка OAuth 2.0 для интеграции с внешними провайдерами
- Поддержка SAML для корпоративных систем
- Автоматическое создание пользователей при первом входе

### LDAP/Active Directory
- Синхронизация пользователей с LDAP
- Автоматическое назначение ролей на основе групп LDAP
- Поддержка аутентификации через LDAP

## API безопасности

### Endpoints аутентификации
- `POST /api/v1/auth/login` - Вход в систему
- `POST /api/v1/auth/refresh` - Обновление токенов
- `POST /api/v1/auth/logout` - Выход из системы
- `POST /api/v1/auth/forgot-password` - Восстановление пароля
- `POST /api/v1/auth/reset-password` - Сброс пароля

### Endpoints управления пользователями
- `GET /api/v1/users` - Получение списка пользователей
- `POST /api/v1/users` - Создание пользователя
- `GET /api/v1/users/{id}` - Получение информации о пользователе
- `PUT /api/v1/users/{id}` - Обновление информации о пользователе
- `DELETE /api/v1/users/{id}` - Удаление пользователя

### Endpoints ролей
- `GET /api/v1/roles` - Получение списка ролей
- `POST /api/v1/roles` - Создание новой роли
- `GET /api/v1/roles/{id}` - Получение информации о роли
- `PUT /api/v1/roles/{id}` - Обновление роли
- `DELETE /api/v1/roles/{id}` - Удаление роли

### Endpoints аудита
- `GET /api/v1/audit` - Получение аудит лога
- `GET /api/v1/audit/users/{userId}` - Получение лога пользователя
- `GET /api/v1/audit/entities/{type}/{id}` - Получение лога сущности

## Конфигурация безопасности

### Переменные окружения
```env
JWT_ACCESS_SECRET=supersecretkey
JWT_REFRESH_SECRET=supersecretrefreshkey
JWT_ACCESS_EXPIRES_IN=900000
JWT_REFRESH_EXPIRES_IN=604800000
SECURITY_RATE_LIMIT_WINDOW=3600000
SECURITY_RATE_LIMIT_MAX=1000
SECURITY_SALT_ROUNDS=12
```

### Защита конфигурации
- Все секреты хранятся в HashiCorp Vault или AWS Secrets Manager
- Конфигурация валидируется при запуске приложения
- Используется Zod для валидации конфигурации